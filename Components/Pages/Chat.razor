@page "/chat"
@attribute [Authorize]
@rendermode InteractiveServer
@using System
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.EntityFrameworkCore
@using BlazorSignalRApp.Data
@using BlazorSignalRApp.Models
@inject NavigationManager Navigation
@inject IDbContextFactory<ApplicationDbContext> UserDbFactory
@implements IAsyncDisposable

<PageTitle>üí¨ Chat</PageTitle>

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-slate-900 dark:to-indigo-950 py-8 px-4 text-gray-900 dark:text-gray-100">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 dark:border-gray-700/50 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6">
                <h1 class="text-3xl font-bold text-white dark:text-white flex items-center gap-3">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                        <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                    </svg>
                    Real-Time Messenger
                </h1>
                <p class="text-indigo-100 dark:text-indigo-200 mt-1 text-sm">Connect and chat in real-time</p>
            </div>

            <div class="p-6">
                <!-- User Selection Card -->
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800/50 dark:to-gray-900/50 rounded-2xl p-5 mb-6 border border-gray-200 dark:border-gray-700">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                Search User
                            </label>
                            <input type="search"
                                   @bind="userFilter"
                                   @bind:event="oninput"
                                   placeholder="Type to filter users..."
                                   class="w-full px-4 py-3 pl-10 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm
                                          focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all
                                          text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500" />
                            <svg class="w-5 h-5 absolute left-3 top-11 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                Select User
                            </label>
                            <InputSelect @bind-Value="selectedUserId"
                                         class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm
                                                focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all
                                                text-gray-900 dark:text-gray-100 cursor-pointer">
                                <option value="">Choose a user to chat with</option>
                                @foreach (var user in FilteredUsers)
                                {
                                    <option value="@user.Id">@user.Name (@user.Role)</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-inner border-2 border-gray-100 dark:border-gray-700 overflow-hidden mb-4">
                    <div id="messagesList"
                         class="h-[500px] overflow-y-auto p-6 space-y-4 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
                        @if (messages.Count == 0)
                        {
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500">
                                <svg class="w-24 h-24 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <p class="text-lg font-medium">No messages yet</p>
                                <p class="text-sm">Start a conversation by sending a message</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var chat in messages)
                            {
                                bool isSelf = chat.UserName == SelectedUserName;
                                <div class="flex @(isSelf ? "justify-end" : "justify-start") animate-fade-in">
                                    <div class="max-w-[75%] group">
                                        @if (!isSelf)
                                        {
                                            <div class="flex items-center gap-2 mb-1 ml-1">
                                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                                    @chat.UserName?.Substring(0, 1).ToUpper()
                                                </div>
                                                <span class="text-xs font-semibold text-gray-600 dark:text-gray-400">@chat.UserName</span>
                                            </div>
                                        }
                                        <div class="px-4 py-3 rounded-2xl shadow-md transition-all duration-200 hover:shadow-lg
                                                    @(isSelf
                                                        ? "bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-br-md"
                                                        : "bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-100 rounded-bl-md")">
                                            <div class="text-sm leading-relaxed break-words">@chat.Message</div>
                                            <div class="text-xs mt-1.5 @(isSelf ? "text-indigo-200" : "text-gray-500 dark:text-gray-400")">
                                                @chat.SentAt.ToLocalTime().ToString("HH:mm")
                                            </div>
                                        </div>
                                        @if (isSelf)
                                        {
                                            <div class="flex justify-end items-center gap-2 mt-1 mr-1">
                                                <span class="text-xs font-semibold text-gray-600 dark:text-gray-400">You</span>
                                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold">
                                                    @chat.UserName?.Substring(0, 1).ToUpper()
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Message Input -->
                <div class="relative">
                    <div class="flex gap-3 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800/50 dark:to-gray-900/50 rounded-2xl p-3 border-2 border-gray-200 dark:border-gray-700 focus-within:border-indigo-500 transition-all">
                        <input @bind="messageInput"
                               @bind:after="StateHasChanged"
                               @onkeydown="HandleKeyPress"
                               placeholder="Type your message..."
                               class="flex-grow px-4 py-3 bg-white dark:bg-gray-800 border-0 rounded-xl shadow-sm
                                      focus:ring-2 focus:ring-indigo-500 outline-none transition-all
                                      dark:text-gray-100 placeholder-gray-400" />
                        <button @onclick="Send"
                                disabled="@(!CanSend)"
                                class="px-6 py-3 rounded-xl text-white font-semibold transition-all duration-200 transform hover:scale-105
                                       bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 
                                       hover:from-indigo-700 hover:via-purple-700 hover:to-pink-700
                                       disabled:opacity-40 disabled:cursor-not-allowed disabled:transform-none
                                       shadow-lg hover:shadow-xl flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            Send
                        </button>
                    </div>
                    @if (!IsConnected)
                    {
                        <div class="absolute -top-12 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 border border-yellow-300 dark:border-yellow-700 rounded-xl p-2 text-center text-sm text-yellow-800 dark:text-yellow-200">
                            ‚ö†Ô∏è Reconnecting...
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400 flex items-center justify-center gap-2">
            <div class="w-2 h-2 rounded-full @(IsConnected ? "bg-green-500 animate-pulse" : "bg-red-500")"></div>
            <span>@(IsConnected ? "Connected" : "Disconnected")</span>
            @if (SelectedUserName != null)
            {
                <span class="text-gray-400">‚Ä¢</span>
                <span>Chatting with <strong class="text-indigo-600 dark:text-indigo-400">@SelectedUserName</strong></span>
            }
        </div>
    </div>
</div>

<style>
    @@keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }

    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #4b5563;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .dark .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
    }
</style>

@code {
    private HubConnection? hubConnection;
    private List<ChatMessage> messages = [];
    private List<User> users = [];
    private string? messageInput;
    private string userFilter = string.Empty;
    private int? selectedUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
        await LoadMessageHistoryAsync();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<string, string, DateTime>("ReceiveMessage", (user, message, sentAt) =>
        {
            messages.Add(new ChatMessage
            {
                UserName = user,
                Message = message,
                SentAt = sentAt
            });
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task Send()
    {
        if (hubConnection is null || !selectedUserId.HasValue || string.IsNullOrWhiteSpace(messageInput))
            return;

        await hubConnection.SendAsync("SendMessage", selectedUserId.Value, messageInput);
        messageInput = string.Empty;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && CanSend)
        {
            await Send();
        }
    }

    private async Task LoadUsersAsync()
    {
        await using var context = await UserDbFactory.CreateDbContextAsync();
        users = await context.ChatUsers
            .AsNoTracking()
            .OrderBy(u => u.Name)
            .ToListAsync();

        selectedUserId ??= users.FirstOrDefault()?.Id;
    }

    private async Task LoadMessageHistoryAsync()
    {
        await using var context = await UserDbFactory.CreateDbContextAsync();
        var history = await context.ChatMessages
            .AsNoTracking()
            .OrderByDescending(m => m.SentAt)
            .Take(50)
            .ToListAsync();

        history.Reverse();
        messages = history;
    }

    private IEnumerable<User> FilteredUsers => string.IsNullOrWhiteSpace(userFilter)
        ? users
        : users.Where(u => u.Name?.Contains(userFilter, StringComparison.OrdinalIgnoreCase) == true);

    private bool CanSend => IsConnected && selectedUserId.HasValue && !string.IsNullOrWhiteSpace(messageInput);
    private string? SelectedUserName => users.FirstOrDefault(u => u.Id == selectedUserId)?.Name;
    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
