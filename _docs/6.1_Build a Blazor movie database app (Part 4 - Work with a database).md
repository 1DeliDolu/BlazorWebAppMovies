# ğŸ¬ Blazor film veritabanÄ± uygulamasÄ± oluÅŸturun (BÃ¶lÃ¼m 4 - VeritabanÄ± ile Ã§alÄ±ÅŸÄ±n)

## ğŸ§° AraÃ§larÄ±nÄ±zÄ± seÃ§in

Bu makale, bir film veritabanÄ±nÄ± yÃ¶netme Ã¶zelliklerine sahip bir **ASP.NET Core Blazor Web UygulamasÄ±** oluÅŸturmanÄ±n temellerini Ã¶ÄŸreten Blazor film veritabanÄ± uygulamasÄ± eÄŸitim serisinin dÃ¶rdÃ¼ncÃ¼ bÃ¶lÃ¼mÃ¼dÃ¼r.

Bu bÃ¶lÃ¼m,  **veritabanÄ± baÄŸlamÄ±na** , veritabanÄ± ÅŸemasÄ±na ve verilerle doÄŸrudan Ã§alÄ±ÅŸmaya odaklanÄ±r. AyrÄ±ca veritabanÄ±nÄ± veriyle **tohumlama (seeding)** konusunu da kapsar.

---

## ğŸ” Ãœretim uygulamalarÄ± iÃ§in gÃ¼venli kimlik doÄŸrulama akÄ±ÅŸÄ±

Bu eÄŸitim, kullanÄ±cÄ± kimlik doÄŸrulamasÄ± gerektirmeyen yerel bir veritabanÄ± kullanÄ±r.

Ãœretim uygulamalarÄ±, mevcut en gÃ¼venli kimlik doÄŸrulama yÃ¶ntemini kullanmalÄ±dÄ±r. Daha fazla bilgi iÃ§in aÅŸaÄŸÄ±daki kaynaklara bakÄ±n:

* ASP.NET Core Blazor kimlik doÄŸrulama ve yetkilendirme
* OpenID Connect (OIDC) ile bir ASP.NET Core Blazor Web UygulamasÄ±nÄ± gÃ¼venceye alÄ±n
* Microsoft Entra ID ile bir ASP.NET Core Blazor Web UygulamasÄ±nÄ± gÃ¼venceye alÄ±n

Microsoft Azure hizmetleri iÃ§in **yÃ¶netilen kimliklerin (Managed Identities)** kullanÄ±lmasÄ± Ã¶nerilir. YÃ¶netilen kimlikler, kimlik bilgilerini kodda depolamadan Azure hizmetlerine gÃ¼venli eriÅŸim saÄŸlar.

Kaynaklar:

* Azure kaynaklarÄ± iÃ§in yÃ¶netilen kimlikler nedir?
* Azure hizmetleri belgeleri
* Azure SQL iÃ§in yÃ¶netilen kimlikler
* App Service ve Azure Functions ile yÃ¶netilen kimlikler

---

## ğŸ—„ï¸ VeritabanÄ± baÄŸlamÄ±

**BlazorWebAppMoviesContext** adlÄ± veritabanÄ± baÄŸlamÄ±, veritabanÄ±na baÄŸlanÄ±r ve model nesnelerini veritabanÄ± kayÄ±tlarÄ±na eÅŸler.

Bu baÄŸlam serinin ikinci bÃ¶lÃ¼mÃ¼nde oluÅŸturulmuÅŸtur. AÅŸaÄŸÄ±daki kod, Program dosyasÄ±nda bulunur:

```csharp
builder.Services.AddDbContextFactory<BlazorWebAppMoviesContext>(options =>
    options.UseSqlite(
        builder.Configuration.GetConnectionString("BlazorWebAppMoviesContext") ?? 
        throw new InvalidOperationException(
            "Connection string 'BlazorWebAppMoviesContext' not found.")));
```

* `AddDbContextFactory`, baÄŸlam iÃ§in bir fabrika oluÅŸturur ve hizmet koleksiyonuna ekler.
* `UseSqlServer` veya `UseSqlite`, baÄŸlamÄ±n Microsoft SQL Server veya SQLite veritabanÄ±na baÄŸlanmasÄ±nÄ± saÄŸlar.
* `GetConnectionString`, yapÄ±landÄ±rma sisteminden baÄŸlantÄ± dizesini okur.

**Yerel geliÅŸtirme** sÄ±rasÄ±nda baÄŸlantÄ± dizesi `appsettings.json` dosyasÄ±ndan alÄ±nÄ±r:

```json
"ConnectionStrings": {
  "BlazorWebAppMoviesContext": "{CONNECTION STRING}"
}
```

ğŸ’¡ **Ã–rnek baÄŸlantÄ± dizesi:**

```
Server=(localdb)\mssqllocaldb;Database=BlazorWebAppMoviesContext-00001111-aaaa-2222-bbbb-3333cccc4444;Trusted_Connection=True;MultipleActiveResultSets=true
```

Uygulama test veya Ã¼retim ortamÄ±na daÄŸÄ±tÄ±ldÄ±ÄŸÄ±nda baÄŸlantÄ± dizesi gÃ¼venli bir ÅŸekilde proje dÄ±ÅŸÄ±nda saklanmalÄ±dÄ±r.

---

## âš ï¸ GÃ¼venlik uyarÄ±sÄ±

Ä°stemci tarafÄ± kodunda aÅŸaÄŸÄ±daki bilgileri **asla** saklamayÄ±n:

* Uygulama sÄ±rlarÄ±
* BaÄŸlantÄ± dizeleri
* Kimlik bilgileri, parolalar, PIN'ler
* Ã–zel C#/.NET kodu veya gizli anahtarlar

Yerel geliÅŸtirmede test iÃ§in **Secret Manager** aracÄ± Ã¶nerilir. Ãœretim ortamÄ±nda ise gÃ¼venli kimlik doÄŸrulama akÄ±ÅŸlarÄ± kullanÄ±lmalÄ±dÄ±r.

---

## ğŸ§± VeritabanÄ± teknolojisi

Bu eÄŸitimin **VS Code** sÃ¼rÃ¼mÃ¼, tam Ã¶zellikli ve taÅŸÄ±nabilir bir SQL veritabanÄ± motoru olan  **SQLite** â€™Ä± kullanÄ±r.

SQLite veritabanlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in **DB Browser for SQLite** gibi araÃ§lar kullanÄ±labilir.

---

## ğŸ”„ EF Core Migrationâ€™larÄ±

Bu eÄŸitimde  **EF Core migration** â€™larÄ± kullanÄ±lÄ±r. Migration, veri modelindeki deÄŸiÅŸikliklerle eÅŸleÅŸecek ÅŸekilde veritabanÄ± ÅŸemasÄ±nÄ± gÃ¼nceller. Ancak yalnÄ±zca EF Core saÄŸlayÄ±cÄ±sÄ±nÄ±n desteklediÄŸi deÄŸiÅŸiklikler yapÄ±labilir.

---

## ğŸŒ± VeritabanÄ±nÄ± tohumlama (Seed the database)

Tohumlama kodu, test veya Ã¼retim iÃ§in baÅŸlangÄ±Ã§ verilerini oluÅŸturabilir.

ğŸ“„ **Data/SeedData.cs**

```csharp
using Microsoft.EntityFrameworkCore;
using BlazorWebAppMovies.Models;

namespace BlazorWebAppMovies.Data;

public class SeedData
{
    public static void Initialize(IServiceProvider serviceProvider)
    {
        using var context = new BlazorWebAppMoviesContext(
            serviceProvider.GetRequiredService<
                DbContextOptions<BlazorWebAppMoviesContext>>());

        if (context == null || context.Movie == null)
        {
            throw new NullReferenceException(
                "Null BlazorWebAppMoviesContext or Movie DbSet");
        }

        if (context.Movie.Any())
        {
            return;
        }

        context.Movie.AddRange(
            new Movie
            {
                Title = "Mad Max",
                ReleaseDate = new DateOnly(1979, 4, 12),
                Genre = "Sci-fi (Cyberpunk)",
                Price = 2.51M,
            },
            new Movie
            {
                Title = "The Road Warrior",
                ReleaseDate = new DateOnly(1981, 12, 24),
                Genre = "Sci-fi (Cyberpunk)",
                Price = 2.78M,
            },
            new Movie
            {
                Title = "Mad Max: Beyond Thunderdome",
                ReleaseDate = new DateOnly(1985, 7, 10),
                Genre = "Sci-fi (Cyberpunk)",
                Price = 3.55M,
            },
            new Movie
            {
                Title = "Mad Max: Fury Road",
                ReleaseDate = new DateOnly(2015, 5, 15),
                Genre = "Sci-fi (Cyberpunk)",
                Price = 8.43M,
            },
            new Movie
            {
                Title = "Furiosa: A Mad Max Saga",
                ReleaseDate = new DateOnly(2024, 5, 24),
                Genre = "Sci-fi (Cyberpunk)",
                Price = 13.49M,
            });

        context.SaveChanges();
    }
}
```

ğŸ’¡ BaÄŸÄ±mlÄ±lÄ±k enjeksiyonu (DI) kapsayÄ±cÄ±sÄ±ndan bir baÄŸlam Ã¶rneÄŸi alÄ±nÄ±r.

VeritabanÄ±nda film varsa iÅŸlem durdurulur; boÅŸsa **Mad Max** serisinden filmler eklenir.

**Program.cs** dosyasÄ±nda `var app = builder.Build();` satÄ±rÄ±ndan sonra aÅŸaÄŸÄ±daki kodu ekleyin:

```csharp
using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;

    SeedData.Initialize(services);
}
```

VeritabanÄ±nda eski test verileri varsa, uygulamayÄ± Ã§alÄ±ÅŸtÄ±rÄ±p bu kayÄ±tlarÄ± silin.

Sonra uygulamayÄ± kapatÄ±n ( **Shift+F5** ).

VeritabanÄ± boÅŸ olduÄŸunda uygulamayÄ± yeniden Ã§alÄ±ÅŸtÄ±rÄ±n ve **Movies Index** sayfasÄ±na gidin.

TohumlanmÄ±ÅŸ **Mad Max** filmleri gÃ¶rÃ¼ntÃ¼lenir.

---

## ğŸ§© Bir formu bir modele baÄŸlama

**Edit.razor** bileÅŸeninde, formun modele nasÄ±l baÄŸlandÄ±ÄŸÄ±nÄ± inceleyin.

Bir kullanÄ±cÄ± `/movies/edit?id=6` adresine gittiÄŸinde:

* `OnInitializedAsync` yÃ¶ntemi, **Id=6** olan filmi alÄ±r ve **Movie** Ã¶zelliÄŸine atar.
* `EditForm.Model` parametresi, formun modelini belirler.
* Form film verileriyle doldurulur.

Form gÃ¶nderildiÄŸinde (`POST`), `[SupplyParameterFromForm]` Ã¶zniteliÄŸi nedeniyle form deÄŸerleri **Movie** modeline baÄŸlanÄ±r:

```csharp
[SupplyParameterFromForm]
private Movie? Movie { get; set; }
```

HatalÄ± model durumunda form tekrar gÃ¶sterilir. Hata yoksa film kaydedilir.

---

## âš™ï¸ EÅŸzamanlÄ±lÄ±k (Concurrency) istisnalarÄ±

**Edit.razor** iÃ§indeki `UpdateMovie` metodu:

```csharp
private async Task UpdateMovie()
{
    using var context = DbFactory.CreateDbContext();
    context.Attach(Movie!).State = EntityState.Modified;

    try
    {
        await context.SaveChangesAsync();
    }
    catch (DbUpdateConcurrencyException)
    {
        if (!MovieExists(Movie!.Id))
        {
            NavigationManager.NavigateTo("notfound");
        }
        else
        {
            throw;
        }
    }

    NavigationManager.NavigateTo("/movies");
}
```

Bir kullanÄ±cÄ± filmi silerken diÄŸerinin aynÄ± filme deÄŸiÅŸiklik gÃ¶ndermesi durumunda **concurrency exception** oluÅŸur.

ğŸ” Test etmek iÃ§in:

1. Bir filmi **Edit** ile aÃ§Ä±n, deÄŸiÅŸiklik yapÄ±n ama  **Save** â€™e basmayÄ±n.
2. BaÅŸka bir pencerede aynÄ± filmi **Delete** ile silin.
3. Ä°lk pencerede  **Save** â€™e basÄ±n â†’ 404 (Not Found) sayfasÄ±na yÃ¶nlendirilirsiniz.

---

## ğŸ›‘ UygulamayÄ± kapatma

Uygulama Ã§alÄ±ÅŸÄ±yorsa, tarayÄ±cÄ±yÄ± kapatÄ±n ve **Shift+F5** ile iÅŸlemi durdurun.

---

## ğŸ§­ Sorun giderme

Bir hata ile karÅŸÄ±laÅŸÄ±rsanÄ±z, kodunuzu **Blazor Ã¶rnek deposundaki** tamamlanmÄ±ÅŸ sÃ¼rÃ¼mle karÅŸÄ±laÅŸtÄ±rÄ±n:

ğŸ”— [Blazor samples GitHub repository (dotnet/blazor-samples)](https://github.com/dotnet/blazor-samples)

Bu eÄŸitimin proje klasÃ¶rÃ¼: **BlazorWebAppMovies**

---

## ğŸ“š Ek kaynaklar

### âš™ï¸ YapÄ±landÄ±rma:

* Configuration in ASP.NET Core
* ASP.NET Core Blazor configuration
* Data seeding (EF Core docs)
* Concurrency with EF Core in Blazor apps

### ğŸ—„ï¸ VeritabanÄ± saÄŸlayÄ±cÄ±larÄ±:

* EF Core documentation
* SQLite EF Core Database Provider Limitations
* SQLite ALTER TABLE statement

### ğŸ” GÃ¼venlik:

* ASP.NET Core Blazor authentication and authorization
* OpenID Connect (OIDC)
* Microsoft Entra ID

---

## âš–ï¸ Yasal

 **Mad Max** ,  **The Road Warrior** ,  **Mad Max: Beyond Thunderdome** ,  **Mad Max: Fury Road** , ve  **Furiosa: A Mad Max Saga** ,

 *Warner Bros. Entertainment* â€™Ä±n tescilli ticari markalarÄ±dÄ±r.
